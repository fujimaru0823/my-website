<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>å†™çœŸä»˜ãåœ°å›³ï¼ˆæ—¥æ™‚å…¥åŠ›ï¼†å‰Šé™¤ï¼†URLå…±æœ‰æ©Ÿèƒ½ä»˜ãï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {
      height: 700px;
      width: 100%;
      margin-bottom: 10px;
    }
    #fileInput {
      display: none;
    }
    .popup-img {
      width: 200px;
      display: block;
      margin: 5px 0;
    }
    .delete-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    #shareUrl {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h2>å†™çœŸï¼‹ã‚³ãƒ¡ãƒ³ãƒˆï¼‹æ—¥æ™‚å…¥åŠ›ï¼‹å‰Šé™¤ï¼‹URLå…±æœ‰æ©Ÿèƒ½ä»˜ãåœ°å›³</h2>
<p>ã‚¯ãƒªãƒƒã‚¯ã§ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã€ç”»åƒã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚</p>

<button id="shareBtn" style="background:#f00;color:#fff;padding:8px;border:none;cursor:pointer;margin-bottom:10px;">
  å…±æœ‰ç”¨URLã‚’ç”Ÿæˆ
</button>
<input type="text" id="shareUrl" placeholder="ã“ã“ã«å…±æœ‰ç”¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™" readonly>

<div id="map"></div>
<input type="file" id="fileInput" accept="image/*" />

<script>
  const STORAGE_KEY = 'savedMarkers';
  const map = L.map('map').setView([38.725213, 139.827071], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let markerList = [];
  let tempLatLng = null;
  let tempImageBase64 = null;

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—HTMLç”Ÿæˆ
  function createPopupContent(data, index) {
    const { comment, image, lat, lng, datetime } = data;
    return `
      <b>ã‚³ãƒ¡ãƒ³ãƒˆ:</b><br>${comment}<br>
      <b>æ—¥æ™‚:</b> ${datetime || 'æœªè¨­å®š'}<br>
      ${image ? `<img src="${image}" class="popup-img"><br>` : ''}
      <small>ç·¯åº¦: ${lat.toFixed(6)}<br>çµŒåº¦: ${lng.toFixed(6)}</small><br>
      <button class="delete-btn" onclick="deleteMarkerAt(${index})">ğŸ—‘ï¸ å‰Šé™¤</button>
    `;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
  function saveMarkersToStorage(markers) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(markers));
  }

  // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
  function addMarker(data, index) {
    const marker = L.marker([data.lat, data.lng]).addTo(map);
    marker.bindPopup(createPopupContent(data, index));
    markerList[index] = marker;
  }

  // ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
  function deleteMarkerAt(index) {
    if (!confirm('æœ¬å½“ã«ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    map.removeLayer(markerList[index]);
    markerList.splice(index,1);
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    saved.splice(index,1);
    saveMarkersToStorage(saved);
    updateAllPopups();
  }
  window.deleteMarkerAt = deleteMarkerAt; // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ï¼ˆonclickç”¨ï¼‰

  // å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ›´æ–°
  function updateAllPopups() {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    markerList.forEach((marker,i) => {
      marker.bindPopup(createPopupContent(saved[i], i));
    });
  }

  // ä¿å­˜æ¸ˆã¿ãƒãƒ¼ã‚«ãƒ¼ã‚’å¾©å…ƒ
  function loadMarkersFromStorage() {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    saved.forEach((data,i) => {
      addMarker(data, i);
    });
  }

  // URLã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼å¾©å…ƒ
  function loadMarkersFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const markersParam = params.get('markers');
    if (!markersParam) return false;
    try {
      const decoded = decodeURIComponent(markersParam);
      const markers = JSON.parse(decoded);
      if (!Array.isArray(markers)) return false;
      saveMarkersToStorage(markers);
      markers.forEach((data,i) => addMarker(data, i));
      return true;
    } catch(e) {
      console.error('URLã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼å¾©å…ƒå¤±æ•—:', e);
      return false;
    }
  }

  // å…±æœ‰ç”¨URLç”Ÿæˆ
  function generateShareUrl() {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (saved.length === 0) {
      alert("ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    // ä½ç½®ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ—¥æ™‚ãƒ»ç”»åƒã‚’å«ã‚ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    const dataForUrl = saved.map(({lat,lng,comment,datetime,image}) => ({
      lat,lng,comment,datetime,image
    }));
    const encoded = encodeURIComponent(JSON.stringify(dataForUrl));
    const baseUrl = location.origin + location.pathname;
    const shareUrl = `${baseUrl}?markers=${encoded}`;
    document.getElementById('shareUrl').value = shareUrl;
  }

  // ãƒ”ãƒ³è¿½åŠ æ™‚ã®å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  function promptMarkerData(latlng, imageBase64) {
    const comment = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "");
    if (comment === null) return null;
    const datetime = prompt("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: 2025-07-17 12:00)", "");
    if (datetime === null) return null;
    return {
      lat: latlng.lat,
      lng: latlng.lng,
      comment: comment,
      datetime: datetime,
      image: imageBase64 || null
    };
  }

  // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ”ãƒ³è¿½åŠ å‡¦ç†
  map.on('click', async (e) => {
    tempLatLng = e.latlng;
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ä¿ƒã™
    document.getElementById('fileInput').value = null;
    document.getElementById('fileInput').click();

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã®å‡¦ç†ã¯fileInputã®changeã‚¤ãƒ™ãƒ³ãƒˆã§è¡Œã†
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
      // ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã§ãƒ”ãƒ³è¿½åŠ 
      addMarkerWithData(tempLatLng, null);
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const base64Img = reader.result;
      addMarkerWithData(tempLatLng, base64Img);
    };
    reader.readAsDataURL(file);
  });

  // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ ã®å®Ÿéš›ã®å‡¦ç†
  function addMarkerWithData(latlng, imageBase64) {
    const data = promptMarkerData(latlng, imageBase64);
    if (!data) return;
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    saved.push(data);
    saveMarkersToStorage(saved);
    addMarker(data, saved.length -1);
  }

  // å…±æœ‰ãƒœã‚¿ãƒ³
  document.getElementById('shareBtn').addEventListener('click', generateShareUrl);

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚
  if (!loadMarkersFromUrl()) {
    loadMarkersFromStorage();
  }

</script>

</body>
</html>
