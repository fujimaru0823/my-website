<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>å†™çœŸä»˜ãåœ°å›³ï¼ˆæ—¥æ™‚å…¥åŠ›ï¼†å‰Šé™¤æ©Ÿèƒ½ä»˜ãï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {
      height: 1000px;
      width: 100%;
    }
    #fileInput {
      display: none;
    }
    .popup-img {
      width: 200px;
      display: block;
      margin: 5px 0;
    }
    .delete-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
  </style>
</head>
<body>

<h2>å†™çœŸï¼‹ã‚³ãƒ¡ãƒ³ãƒˆï¼‹æ—¥æ™‚å…¥åŠ›ï¼‹å‰Šé™¤æ©Ÿèƒ½ä»˜ãåœ°å›³</h2>
<p>ã‚¯ãƒªãƒƒã‚¯ã§ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã€æ—¥æ™‚ã‚‚å…¥åŠ›ã§ãã¾ã™ã€‚</p>
<div id="map"></div>
<input type="file" id="fileInput" accept="image/*" />

<script>
  const STORAGE_KEY = 'savedMarkers';
  const map = L.map('map').setView([38.725213, 139.827071], 15); // é¶´å²¡å¸‚å½¹æ‰€
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let tempLatLng = null;
  const markerList = [];

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
  function createPopupContent(data, index) {
    const { comment, image, lat, lng, datetime } = data;
    return `
      <b>ã‚³ãƒ¡ãƒ³ãƒˆ:</b><br>${comment}<br>
      <b>æ—¥æ™‚:</b> ${datetime || 'æœªè¨­å®š'}<br>
      <img src="${image}" class="popup-img"><br>
      <small>ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}</small><br>
      <button class="delete-btn" onclick="deleteMarkerAt(${index})">ğŸ—‘ï¸ å‰Šé™¤</button>
    `;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼å¾©å…ƒ
  function loadMarkersFromStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    const markers = JSON.parse(saved);
    markers.forEach((data, index) => {
      addMarker(data, index);
    });
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  function saveMarkersToStorage(markers) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(markers));
  }

  // æ–°è¦ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿å­˜ç”¨ã«è¿½åŠ 
  function addMarkerToStorage(data) {
    const saved = localStorage.getItem(STORAGE_KEY);
    const markers = saved ? JSON.parse(saved) : [];
    markers.push(data);
    saveMarkersToStorage(markers);
  }

  // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆï¼‹è¿½åŠ 
  function addMarker(data, index) {
    const { lat, lng } = data;
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(createPopupContent(data, index));
    markerList[index] = marker;
  }

  // ã™ã¹ã¦ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’æ›´æ–°ï¼ˆindexæ•´åˆæ€§ã®ãŸã‚ï¼‰
  function updateAllPopupContents() {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    markerList.forEach((marker, i) => {
      marker.bindPopup(createPopupContent(saved[i], i));
    });
  }

  // ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
  function deleteMarker(marker, index) {
    map.removeLayer(marker);
    markerList.splice(index, 1);
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    saved.splice(index, 1);
    saveMarkersToStorage(saved);
    updateAllPopupContents();
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (!file || !tempLatLng) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const imageData = event.target.result;
      const comment = prompt("ã“ã®å ´æ‰€ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
      if (!comment || comment.trim() === "") return;

      // æ—¥ä»˜ã¨æ™‚é–“ã‚’å…¥åŠ›ã•ã›ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      let datetime = prompt("æ—¥ä»˜ã¨æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2025-07-03 14:30ï¼‰", getCurrentDateTime());
      if (!datetime || datetime.trim() === "") datetime = "æœªè¨­å®š";

      const lat = parseFloat(tempLatLng.lat.toFixed(6));
      const lng = parseFloat(tempLatLng.lng.toFixed(6));
      const newData = { lat, lng, comment, image: imageData, datetime };

      const index = markerList.length;
      addMarkerToStorage(newData);
      addMarker(newData, index);

      this.value = '';
      tempLatLng = null;
    };
    reader.readAsDataURL(file);
  });

  // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒˆãƒªã‚¬ãƒ¼
  map.on('click', function (e) {
    tempLatLng = e.latlng;
    document.getElementById('fileInput').click();
  });

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  loadMarkersFromStorage();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å‰Šé™¤é–¢æ•°ã‚’å…¬é–‹
  window.deleteMarkerAt = function (index) {
    if (confirm("ã“ã®ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      deleteMarker(markerList[index], index);
    }
  };

  // ç¾åœ¨ã®æ—¥æ™‚æ–‡å­—åˆ—ã‚’è¿”ã™è£œåŠ©é–¢æ•°
  function getCurrentDateTime() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
  }
</script>

</body>
</html>
